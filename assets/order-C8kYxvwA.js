import{s as f}from"./index-1OUVmTX5.js";import{a as s,u as c,b as m}from"./programming-C_qqE9I0.js";import{i as g}from"./axios-DfgZ8BjE.js";async function d(){try{return(await g.get("/products")).data}catch(n){throw n}}function h(){const n=w(),e=new WebSocket("ws://localhost:5000/ws");return e.onmessage=async o=>{try{const r=JSON.parse(o.data);r!=null&&r.module&&await n.handleWorkflowDone(r.module)}catch(r){console.error("WS parse error",r)}},e.onerror=o=>{console.error("WS error",o)},e}const w=f("orderRuntime",{state:()=>({products:[],runtime:{},moduleMap:{}}),getters:{getRuntime:n=>e=>n.runtime[e]||null},actions:{async fetchProducts(){const n=await d();this.products=n,n.forEach(e=>{if(this.moduleMap[e.module]=e.id,!this.runtime[e.id]){const o=Number(localStorage.getItem(`qty:${e.module}`)||0);this.runtime[e.id]={quantity:o,running:!1,robotRunning:!1,mode:"once",locked:!1,onceRunning:!1,prevRunning:!1,loopRunning:!1}}})},async startOnce(n){const e=c();await s({module_name:n,mode:"once",screen:"order"}),await e.fetchWorkflowStatus()},async startLoop(n){const e=c();await s({module_name:n,mode:"loop",screen:"order"}),await e.fetchWorkflowStatus()},async stop(n){const e=c();await m({module_name:n}),await e.fetchWorkflowStatus()},setQuantity(n,e,o){const r=this.runtime[n];r&&(r.quantity=Math.max(0,o),r.quantity>0?localStorage.setItem(`qty:${e}`,String(r.quantity)):(localStorage.removeItem(`qty:${e}`),r.onceRunning=!1))},resetQuantity(n,e){const o=this.runtime[n];o&&(o.quantity=0,o.onceRunning=!1,localStorage.removeItem(`qty:${e}`))},applyWorkflowStatus(n){if(!(n!=null&&n.workflows))return;const e=n.workflows;Object.entries(this.moduleMap).forEach(([o,r])=>{const t=this.runtime[r];if(!t)return;const a=e[o];if(!a){t.running&&(t.mode==="once"&&(t.quantity=0,localStorage.removeItem(`qty:${o}`)),t.running=!1,t.robotRunning=!1,t.mode="once",t.locked=!1,t.loopRunning=!1,t.onceRunning=!1,t.prevRunning=!1);return}const i=!!a.is_running,u=a.mode==="loop",l=t.mode;t.running=i,t.robotRunning=a.is_robot_running,t.mode=a.mode??"once",t.locked=i&&a.screen==="workflow",t.loopRunning=i&&u,t.prevRunning&&!i&&l==="once"&&(t.quantity=0,t.onceRunning=!1,localStorage.removeItem(`qty:${o}`)),t.prevRunning=i})},async handleWorkflowDone(n){const e=this.moduleMap[n];if(!e)return;const o=this.runtime[e];o&&o.mode!=="loop"&&(o.quantity=Math.max(0,o.quantity-1),o.quantity>0?(localStorage.setItem(`qty:${n}`,String(o.quantity)),o.onceRunning=!0,await s({module_name:n,mode:"once",screen:"order"})):(localStorage.removeItem(`qty:${n}`),o.running=!1,o.robotRunning=!1,o.mode="once",o.locked=!1,o.prevRunning=!1,o.onceRunning=!1))}}});export{d as g,h as i,w as u};
